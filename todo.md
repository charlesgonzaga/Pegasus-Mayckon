# Portal XML NFSe - TODO

- [x] Schema do banco de dados multi-tenant (users, contabilidades, clientes, certificados, notas, downloads)
- [x] Autenticação multi-tenant com 3 níveis: Admin, Contabilidade, Cliente
- [x] Upload em lote de certificados digitais (.pfx) com extração automática de CNPJ
- [x] Cadastro automático de clientes a partir dos dados do certificado
- [x] Integração com API NFSe Nacional usando mTLS para download de XMLs
- [x] Download de XMLs por período, CNPJ e em lote separado por cliente
- [x] Armazenamento seguro de certificados criptografados
- [x] Parsing e armazenamento de dados dos XMLs decodificados
- [x] Dashboard com gráficos multi-empresa (emitidas/recebidas, valores, status)
- [x] Sistema de busca e filtros avançados (empresa, período, tipo, status)
- [x] Relatórios dinâmicos exportáveis (CSV/Excel)
- [x] Gestão de usuários com permissões por contabilidade
- [x] Visualização de DANFSe (PDF) via API
- [x] Download automático agendado
- [x] Tema visual profissional com DashboardLayout
- [x] Dados de teste para demonstração
- [x] Testes unitários (60 testes passando)
- [x] Página de Contabilidades
- [x] Página de Clientes
- [x] Página de Certificados com upload em lote
- [x] Página de Notas Fiscais com filtros
- [x] Página de Downloads manual e em lote
- [x] Página de Agendamentos de download automático
- [x] Página de Relatórios com gráficos (Visão Geral, Multi-Empresa, Serviços, Detalhado)
- [x] Página de Configurações com seed de dados de teste
- [x] Sistema de login com usuário e senha (substituir OAuth)
- [x] Tabela de usuários com campo de senha (hash bcrypt)
- [x] Rotas de registro e login no backend
- [x] Página de login com formulário de e-mail e senha
- [x] Página de registro de novos usuários
- [x] Sessão via JWT/cookie próprio
- [x] Primeiro usuário registrado é admin automaticamente
- [x] Gestão de usuários pelo admin (criar contabilidades e vincular)
- [x] Dashboard: mostrar quantidade de certificados vencidos
- [x] Tela de monitoramento de certificados: status vencido/a vencer/válido por cliente
- [x] Indicador de tempo restante para vencimento de cada certificado
- [x] Upload de novo certificado por cliente (renovação individual)
- [x] Upload de certificados em lote (renovação em lote)
- [x] Criar usuário admin com login lan7@gmail.com e senha 123456
- [x] BUG: Remover OAuth do Manus - sistema deve usar apenas login local com usuário/senha
- [x] BUG: Login não mantém sessão - corrigido com Bearer token via localStorage
- [x] BUG DEFINITIVO: Reescrever auth para usar APENAS Bearer token, ignorar cookies/OAuth completamente
- [x] BUG: Upload de certificados em lote - corrigido import ESM do node-forge (forge.default)
- [x] Reestruturar sistema multi-tenant com painéis separados Admin vs Contabilidade
- [x] Schema: tabela de planos com limites (qtd clientes, qtd certificados)
- [x] Schema: status ativo/inativo na contabilidade, vinculo com plano
- [x] Painel Admin: dashboard com visão geral de todas contabilidades
- [x] Painel Admin: CRUD de planos (nome, limite clientes, preço, etc)
- [x] Painel Admin: gestão de contabilidades (habilitar/desabilitar, vincular plano)
- [x] Painel Admin: criar conta de contabilidade com email/senha
- [x] Painel Contabilidade: portal isolado - só vê seus próprios dados
- [x] Painel Contabilidade: importar certificados dos seus clientes
- [x] Painel Contabilidade: dashboard com gráficos dos seus clientes
- [x] Painel Contabilidade: downloads, relatórios, agendamentos isolados
- [x] Isolamento total de dados por contabilidade em todas as queries
- [x] BUG: Erro ao criar plano - corrigido campo maxDownloadsMes->maxDownloadsDia e preço com vírgula
- [x] BUG: Erro SQL na /configuracoes - query DATE_FORMAT em notas falhando (resolvido: página reescrita)
- [x] CRUD completo de contabilidades: editar, salvar e excluir
- [x] Botão apagar notas por cliente específico (contabilidade)
- [x] Botão apagar notas de todos os clientes (contabilidade)
- [x] Visualização do PDF da nota (DANFSe) na coluna Ações da tabela de notas
- [x] Landing page profissional para contadores com explicação do sistema
- [x] Área de login na landing page para contadores acessarem o sistema
- [x] Fluxo: landing page pública → login → dashboard por role (admin/contador)
- [x] BUG: PDF da DANFSe retornando erro 404 (corrigido: gerar DANFSe localmente a partir do XML)
- [x] Agendamento por dia útil do mês: opção de escolher mês e dia útil específico
- [x] Lista de dias úteis calculados dinamicamente para o mês selecionado
- [x] Formulário de agendamento com toggle entre frequência e dia útil
- [x] Botão excluir cliente na tabela de clientes com exclusão em cascata (notas, certificados, downloads, agendamentos)
- [x] Dashboard melhorado: cards com dados úteis, gráficos, filtro por cliente e dados consolidados
- [x] Dashboard: total clientes, certificados ativos/vencidos, último download, próximo agendamento
- [x] Dashboard: gráficos de notas por mês e valores por mês com dados reais
- [x] Download em lote: todos XMLs de uma vez separados por pasta por cliente
- [x] Download em lote: opção de baixar XML, PDF ou ambos
- [x] Download por cliente específico (XML, PDF ou ambos)
- [x] Tela de Relatórios: visualização com dados das notas (número, emitente, tomador, valor, emissão, direção, status)
- [x] Relatórios: exportação em Excel (.xlsx)
- [x] Relatórios: exportação em PDF
- [x] Relatórios: filtro por tipo (Emitidas, Recebidas, Canceladas)
- [x] Tela Visualizar XML: upload de XML, visualização amigável dos dados da nota
- [x] Tela Visualizar XML: conversão do XML para PDF e download
- [x] BUG: Erro SQL DATE_FORMAT no dashboard - query com GROUP BY falhando (corrigido: usar sql.raw)
- [x] BUG: setState durante render na LandingPage (corrigido: useEffect)
- [x] BUG: XML exportado em formato incorreto (corrigido: usar getXmlBatch que decodifica base64+gzip)
- [x] BUG: Visualizar XML não abre (corrigido: detecta e decodifica base64+gzip automaticamente)
- [x] Gerar DANFSe em PDF a partir do XML da nota (sem depender da API externa)
- [x] Visualização da DANFSe no portal com opção de download do PDF
- [x] Download da DANFSe (PDF) oficial junto com o XML ao baixar da API NFSe Nacional
- [x] Armazenar DANFSe PDF no S3 vinculado à nota
- [x] Visualização e download direto do PDF oficial da DANFSe no portal (sem conversão)
- [x] Remover itens do menu admin que são exclusivos do contador (Clientes, Certificados, Validade, Notas, Downloads, Agendamentos, Relatórios, Visualizar XML)
- [x] Campo de alteração de senha no diálogo de Editar Contabilidade (admin pode redefinir senha do contador)
- [x] Rebranding: sistema renomeado para "Pegasus" by Lan7 Tecnologia
- [x] Sistema de 4 temas visuais: Branco, Azul, Verde, Preto
- [x] ThemeContext com persistência em localStorage e suporte a data-theme CSS
- [x] Tabela settings no banco de dados para persistência de configurações
- [x] Backend: procedures CRUD para settings (getAll, get, update, updateMultiple)
- [x] Tela de Personalização no painel admin com seletor visual de temas
- [x] Seletor de temas rápido no sidebar do DashboardLayout
- [x] Landing page redesenhada com branding Pegasus e design responsivo ao tema
- [x] Sidebar atualizado com logo Pegasus e item Personalização no menu admin
- [x] Testes unitários para settings (7 testes passando)
- [x] Downloads: identificar e pular certificados vencidos (só baixar de certificados válidos)
- [x] Downloads: download individual por cliente com estrutura de pastas (NomeEmpresa_Data_HoraMinuto)
- [x] Downloads: subpastas Notas Emitidas, Notas Tomadas, Notas Canceladas (XML + PDF)
- [x] Downloads: incluir relatório Excel por tipo (Emitidas, Recebidas, Canceladas) no download
- [x] Downloads: remover seção Histórico de Downloads da página atual
- [x] Criar tela separada Histórico de Downloads com menu lateral
- [x] Histórico de Downloads: percentual de progresso por item e progresso geral
- [x] Botão para parar/cancelar downloads em andamento
- [x] Mostrar nome da empresa que está sendo baixada no card de progresso e na tabela de histórico
- [x] Botão para limpar histórico de downloads
- [x] BUG: Botão parar downloads não deve afetar downloads travados/que não estão realmente baixando
- [x] Downloads: filtro de período (mês/ano) para escolher quais notas baixar
- [x] Downloads: opção "Somente novas" vs "Baixar tudo" (por período)
- [x] Botão "Parar Todos" na página de Downloads (além do Histórico)
- [x] Corrigir downloads travados que ficam no status "executando" sem estar rodando
- [x] Downloads: filtro de período (mês/ano) para escolher notas a baixar
- [x] Downloads: opção "Somente novas" vs "Baixar por período"
- [x] Admin: tela de Configurações da Página Inicial para alterar logo, textos e conteúdo
- [x] Upload da logo Pegasus NFe e configuração como padrão
- [x] Landing page dinâmica: todos os textos e logo vêm das configurações do admin
- [x] Upload de logo customizada via painel admin (envio para S3)
- [x] Formulário completo para editar: título, subtítulo, descrição, funcionalidades, como funciona, benefícios, rodapé
- [x] BUG: Relatórios não deve gerar automaticamente ao abrir - adicionar botão "Gerar Relatório"
- [x] Relatórios: permitir escolher filtros antes de gerar (empresa, tipo, período)
- [x] FIX: Corrigir erro TS em ConfigPaginaInicial.tsx
- [x] Adicionar rota e menu para ConfigPaginaInicial no admin
- [x] LandingPage dinâmica: ler todos os textos e logo das configurações
- [x] BUG: Visualizar XML - Tomador mostra mesmos dados do Prestador (deveria ser diferente)
- [x] BUG: Visualizar XML - Descrição do Serviço não mostra nada
- [x] Landing page: seção de Contato com Telefone, WhatsApp, E-mail, Instagram, Facebook e Endereço
- [x] Admin Config Página Inicial: campos editáveis para dados de contato
- [x] Visualizar XML: inverter ordem - primeiro Tomador, depois Prestador
- [x] Downloads: busca por período via API NFSe (não apenas do banco local)
- [x] Downloads: modificar downloadAllDocuments para aceitar filtro de competência
- [x] Downloads: atualizar procedures executeForCliente/executeForAll com período para API
- [x] Histórico de Downloads: botão "Retomar" para downloads com status Erro ou Cancelado
- [x] Downloads: botão "Apagar Todos" para excluir todos os clientes da lista de downloads
- [x] Downloads: botão "Apagar" individual em cada linha para excluir cliente específico
- [x] Backend: procedure cliente.deleteAll para excluir todos os clientes de uma contabilidade em cascata
- [x] Backend: db helper deleteAllClientesByContabilidade com exclusão em cascata
- [x] Backend: procedure download.retry para retomar downloads com erro ou cancelados
- [x] Testes: 95 testes passando (6 novos testes para deleteAll e retry)
- [x] Downloads: seletor de empresa na seção Modo de Download (escolher uma empresa ou todas)
- [x] Downloads: botão de ação centralizado na seção Modo de Download para iniciar download
- [x] Downloads: checkbox para selecionar empresas manualmente na tabela de clientes
- [x] Downloads: checkbox "Selecionar Todos" no cabeçalho da tabela
- [x] Downloads: botão de download usa empresas selecionadas via checkbox
- [x] Downloads: redesign completo da página com melhor UX (checkboxes, filtros, ações contextuais)
- [x] Downloads: backend procedure para download de múltiplos clientes selecionados
- [x] Downloads: período com data inicial e final (Mês/Ano início e Mês/Ano fim)
- [x] Downloads: backend procedure executeForSelected para download de múltiplos clientes selecionados
- [x] Clientes: novos campos no schema (contato principal/secundário, telefones, email, endereço, tipo, regime tributário, sócio, data abertura, CNAEs)
- [x] Clientes: tela de edição com formulário completo
- [x] Clientes: consulta automática à Receita Federal via API ao cadastrar pelo certificado
- [x] Clientes: procedure de update de cliente
- [x] Clientes: procedure de consulta CNPJ na Receita Federal
- [x] Clientes: botão Apagar Todos movido para Configurações do Contador
- [x] Sistema: tabela de log de auditoria registrando quem apagou clientes (usuário, data, ação, detalhes)
- [x] Clientes: registrar log de auditoria ao apagar cliente individual ou todos
- [x] Usuários: contador pode criar usuários com login/senha vinculados à contabilidade
- [x] Usuários: permissões granulares via checkboxes (ver clientes, editar, downloads, certificados, histórico, agendamentos, etc.)
- [x] Usuários: ativar/desativar usuários
- [x] Usuários: excluir usuários
- [x] Usuários: página de gerenciamento de usuários na área do contador
- [x] Usuários: verificação de permissões nas procedures existentes
- [x] Downloads: remover botão Apagar Todos clientes (manter apenas para downloads)
- [x] Clientes: redesign em cards com botões Novo/Editar/Excluir/Visualizar
- [x] Clientes: modal de edição completa com todos os campos
- [x] Configurações Contador: mover Apagar Todos Clientes para configurações
- [x] Configurações Contador: gerenciamento de usuários com permissões via checkboxes
- [x] Clientes: mover botão "Preencher via Receita Federal" para aba Dados do modal de edição
- [x] Clientes: toggle Ativar/Desativar no card do cliente na tela principal
- [x] BUG: Erro 403 Forbidden na consulta CNPJ via BrasilAPI - corrigir integração
- [x] Clientes: botão "Preencher Todos via Receita" ao lado da busca para consultar BrasilAPI em lote
- [x] Clientes: mover botão "Preencher via Receita" da aba Fiscal para aba Dados no modal de edição
- [x] Clientes: toggle Ativar/Desativar no card do cliente na tela principal
- [x] BUG: corrigir erro 403 Forbidden na consulta CNPJ via BrasilAPI (adicionado fallback ReceitaWS + User-Agent)
- [x] Backend: procedure consultarReceitaEmLote para consultar todos os clientes de uma vez
- [x] Downloads: botão "ZIP Selecionadas" para baixar ZIP consolidado de todas as empresas selecionadas via checkbox
- [x] BUG: Permissões de usuário não funcionam - usuário criado com permissões limitadas consegue acessar tudo
- [x] Backend: verificar permissões do usuário nas procedures protegidas
- [x] Frontend: esconder menus no sidebar baseado nas permissões do usuário
- [x] Frontend: bloquear rotas/páginas baseado nas permissões do usuário
- [x] Frontend: redirecionar usuário sem permissão para página permitida
- [x] Auditoria: botão apagar registro individual
- [x] Auditoria: botão apagar todos os registros de uma vez
- [x] Auditoria: nova permissão "gerenciarAuditoria" para controlar quem pode apagar
- [x] Agendamento: garantir que funcione no servidor sem depender do navegador aberto (cron job server-side)
- [x] Configurações > Minha Conta: formulário de troca de senha (senha atual, nova senha, confirmação) com validação e feedback visual
- [x] Auditoria: editar registro de auditoria (observações/detalhes)
- [x] Auditoria: apagar registro individual com confirmação
- [x] Auditoria: apagar todos os registros de uma vez com confirmação
- [x] Auditoria: relatório PDF filtrado por usuário específico ou todos os usuários
- [x] Permissão "Ver Dashboard" controlável pelo admin/contador para cada usuário
- [x] Esconder menu Dashboard no sidebar quando usuário não tem permissão
- [x] Bloquear rota /dashboard quando usuário não tem permissão
- [x] Backend: checkPermissao verDashboard na procedure de dashboard stats
- [x] BUG: Apagar Todos Clientes não apaga notas fiscais - notas permanecem no banco após exclusão dos clientes
- [x] BUG: Progresso mostra 100% mas status ainda "Executando" - progresso não reflete etapas pós-download (processamento, DANFSe)
- [x] Melhoria: adicionar campo de etapa/descrição no download_logs para mostrar o que está sendo feito
- [x] Melhoria: progresso real dividido em fases (download notas, processamento, busca DANFSe)
- [x] Frontend: mostrar descrição da etapa atual no card de progresso e na tabela de histórico
- [x] BUG: Download ZIP não inclui PDF de todas as notas - faltam PDFs (19 XMLs mas apenas 3 PDFs)
- [x] Melhoria: retry na busca de DANFSe PDF quando falha (HTTP 502)
- [x] Melhoria: garantir que ZIP tenha mesma quantidade de XML e PDF
- [x] Melhoria: Skip & Retry no download de PDFs - pular notas com erro e retornar depois
- [x] Melhoria: Timeout por nota para evitar travamento no download de PDF
- [x] Configurações: Campo para definir número máximo de tentativas de download de PDF por nota
- [x] Backend: Lógica de retry com contagem de tentativas e skip automático
- [x] Prioridade: XML é o mais importante - se PDF falhar, pula e continua
- [x] Uma empresa não deve interromper download das outras empresas
- [x] Relatório minucioso do histórico de downloads em PDF
- [x] Relatório minucioso do histórico de downloads em Excel
- [x] Histórico: mostrar quantidade de XMLs baixados por empresa/linha
- [x] Histórico: mostrar quantidade de PDFs baixados por empresa/linha
- [x] Histórico: mostrar quantidade de erros de PDF por empresa/linha
- [x] Backend: adicionar campos totalXml, totalPdf, errosPdf na tabela download_logs
- [x] Backend: atualizar procedures de download para contabilizar XMLs, PDFs e erros separadamente
- [x] Frontend: Adicionar campos de data completa (dd/mm/yyyy) no modo "Buscar por período"
- [x] Backend: Suportar filtro por data exata (dia específico) além de competência (mês/ano)
- [x] Permitir intervalo de dias específicos (ex: 01/02/2026 a 10/02/2026)
- [x] Documentação: Manual de implantação/instalação do sistema (simplificado)
- [x] Documentação: Manual do usuário ilustrativo (todas as telas e campos)
- [x] Frontend: Página de Ajuda com visualização dos manuais
- [x] Frontend: Menu Ajuda na navegação do sistema (sidebar)
- [x] Frontend: Download dos manuais em PDF
- [x] Remover manual de implantação da página de Ajuda do sistema
- [x] Gerar manual de implantação como documento externo para download
- [x] Refazer manual do usuário com screenshots ilustrados e setas
- [x] Fluxo ilustrado: 1) Upload certificados 2) Download notas 3) Histórico 4) ZIP
- [x] BUG: Downloads travados devem ser retomados automaticamente seguindo o número de tentativas configurado
- [x] Backend: detectar downloads travados (status executando sem progresso por tempo prolongado)
- [x] Backend: retry automático de downloads travados respeitando maxRetries das configurações
- [x] Histórico: botão ZIP por empresa em cada linha da tabela
- [x] Histórico: botão ZIP Todas as empresas no topo da página
- [x] Configurações: opção para escolher modo de download (Fila sequencial ou Todos em paralelo)
- [x] Backend: refatorar executeForAll para suportar modo fila e paralelo
- [x] Backend: refatorar executeForSelected para suportar modo fila e paralelo
- [x] Frontend: campo na página de Configurações para selecionar modo de download
- [x] Configurações: opção de auto-correção pós-conclusão (retentar PDFs com erro após todos terminarem)
- [x] Backend: após todos os downloads concluírem, identificar empresas com erros de PDF e retentar automaticamente
- [x] Backend: status "Corrigido" ou "Falha" para cada empresa após auto-correção
- [x] Frontend: exibir status de auto-correção no Histórico de Downloads
- [x] BUG: Barra de progresso geral mostrando percentual acima de 100% (ex: 1335%)
- [x] Frontend: Adicionar barra de progresso visual em cada card de empresa na seção de downloads em andamento
- [x] BUG: Downloads sem notas marcados como "travado" em vez de "concluído sem notas"
- [x] Backend: diferenciar "sem notas no período" de erros reais (API, certificado, etc.)
- [x] Backend: quando não há notas, concluir normalmente com mensagem "Nenhuma nota encontrada"
- [x] Backend: mensagens de erro específicas para cada tipo de falha
- [x] Frontend: exibir mensagens de erro claras e específicas no histórico
- [x] Relatórios: incluir motivo do erro/status nos relatórios PDF e Excel
- [x] BUG: Auto-correção de PDFs não está funcionando após downloads concluírem
- [x] Configurações: campo de tempo de espera (HH:MM:SS) antes de iniciar auto-correção
- [x] Backend: implementar delay configurável antes de iniciar auto-correção
- [x] Backend: auto-correção com logs detalhados (console.log) e status intermediários
- [x] Backend: auto-correção define status "executando" durante processamento e "concluido" ao final
- [x] Backend: detecção de travamento ignora logs com totalEsperado=0 (sem notas) e logs em auto-correção
- [x] Backend: executeForCliente trata docs.length === 0 como "Nenhuma nota encontrada no período"
- [x] Backend: mensagens de erro específicas no catch de executeForCliente (PKCS12, SSL, timeout, etc.)
- [x] Frontend: badges "Corrigido" (verde esmeralda) e "Corrigido Parcial" (âmbar) no histórico
- [x] Frontend: campo de tempo de espera HH:MM:SS na seção de auto-correção das Configurações
- [x] Backend: procedures getAutoCorrecaoTempo e setAutoCorrecaoTempo com validação de formato
- [x] Testes: 150 testes passando (21 novos testes para tratamento de erros, auto-correção e tempo de espera)
- [x] Reverter tela Histórico de Downloads para formato anterior (remover badges Corrigido/Corrigido Parcial)
- [x] Manter apenas indicações de erro de PDF, erro de XML e sem notas no histórico
- [x] Histórico: mostrar motivo claro na coluna Progresso quando não baixou notas (Sem Notas, Cert. Vencido, erro API, erro PDF, etc.)
- [x] BUG: Coluna Progresso mostra HTML bruto da API (ex: "Failed to parse API response: <html>...") - limpar para mensagem legível
- [x] Histórico: botão "Retomar Todas" para retentar todos os downloads com erro de uma vez
- [x] Backend: procedure retryAll para retomar todos os downloads com erro
- [x] Auto-correção: garantir que funcione e mostre status no histórico quando ativada no tempo programado
- [x] Histórico: ordenar tabela com concluídos no topo, depois executando, depois erro/cancelado
- [x] BUG: Auto-correção programada não funciona - reescrever para usar mesma lógica do botão Retomar Todas (processClienteDownload)
- [x] Histórico: reordenar tabela - executando no topo, depois concluídos, depois demais (erro, cancelado, sem notas)
- [x] Configurações: atualizar texto descritivo da auto-correção de PDFs
- [x] Configurações: atualizar texto descritivo da auto-correção para "parados ou terminados"
- [x] Backend: auto-correção dispara em background (não bloqueia resposta) e retenta todos com erro/cancelados
- [x] Downloads: clientes com certificado vencido não podem ser selecionados para download (mostrar mas desabilitar)
- [x] Backend: excluir clientes com certificado vencido do executeForAll e retryAll
- [x] BUG: Erro "Unexpected token '<'" quando API retorna HTML (429) em vez de JSON durante download em lote
- [x] Melhorar mensagem de erro HTTP 404 - empresa não cadastrada na API Nacional NFSe
- [x] BUG CRÍTICO: Todos os downloads dando erro "Empresa não cadastrada" (404) - investigar causa real
- [x] Pesquisar e aplicar melhores práticas da API Nacional NFSe para downloads
- [x] Implementar controle de taxa de requisições (rate limiting) para evitar erros 429
- [x] Configurações: substituir "Modo de Download" (sequencial/paralelo) por controle de delay entre requisições (1-60 segundos)
- [x] Backend: forçar processamento sequencial com delay entre empresas, retry com backoff para 429/5xx
- [x] BUG: HTTP 404 com JSON válido (NENHUM_DOCUMENTO_LOCALIZADO) tratado como erro - corrigir para tratar como "sem notas"
- [x] Downloads: ao clicar em Baixar, lançar TODAS as empresas no Histórico imediatamente com status "Pendente"
- [x] Backend: criar logs de download para todas as empresas de uma vez (status pendente), depois processar sequencialmente em background
- [x] Backend: processamento sequencial em background atualiza cada log conforme vai baixando (pendente → executando → concluído/erro)
- [x] Frontend: exibir badge "Na Fila" (âmbar) no Histórico de Downloads para empresas aguardando na fila
- [x] Mesma lógica para executeForAll, executeForSelected e retryAll
- [x] Relatório PDF Histórico: redesign completo com cabeçalho rico (data, hora, usuário, totais, erros)
- [x] Relatório PDF Histórico: ícones visuais nos status (concluído, erro, pendente, executando)
- [x] Relatório PDF Histórico: mini gráfico demonstrativo (pizza/barras) no resumo
- [x] Relatório PDF Histórico: linhas maiores para melhor legibilidade
- [x] Relatório PDF Histórico: informações no cabeçalho - quantidade de certificados processados e erros
- [x] Retry: ao retomar (retryOne, retryAll E auto-correção), mudar status do log para "retomando"
- [x] Retry: registro retomando deve subir para o topo da lista (junto com executando/na fila)
- [x] Retry: mostrar progresso igual ao download normal no card de Download em Andamento
- [x] Frontend: badge "Retomando" com cor roxa diferenciada no histórico
- [x] Auto-Correção: renomear para "Auto-Retomada de Downloads" (não é só PDF)
- [x] Auto-Correção: retomar download completo (XML+PDF) das empresas que deram erro, não apenas PDFs
- [x] Frontend Configurações: atualizar título, descrição e textos da seção Auto-Correção
- [x] Auto-Retomada: manter campo de tempo de espera configurável antes de iniciar a retomada automática
- [x] Auto-Retomada: mostrar aviso/banner visual no Histórico quando auto-retomada estiver em andamento
- [x] BUG CRÍTICO: Fila de downloads trava - após processar algumas empresas, pendentes ficam paradas (0 em execução, 13 na fila)
- [x] Recovery: ao iniciar o servidor, detectar downloads órfãos (pendente/executando/retomando) e retomá-los automaticamente
- [x] Recovery: lock para evitar recovery concorrente em caso de múltiplos restarts
- [x] Configurações: toggle para ativar/desativar download de PDFs (DANFSe)
- [x] Backend: ler configuração "baixar_pdf" e pular download de PDF quando desativado
- [x] Frontend: seção "Download de PDFs" nas Configurações com toggle e descrição
- [x] Relatório tela: adicionar coluna "Serviço Prestado" na tabela de notas
- [x] Relatório tela: destacar visualmente se nota é Emitente ou Tomador
- [x] Relatório Excel: separar em 3 abas - Geral, Emitente, Tomador
- [x] Relatório PDF: destacar Emitente vs Tomador
- [x] BUG: Erro ao gerar ZIP para empresas com muitas notas (3791+) - otimizado para não re-baixar PDFs via mTLS
- [x] BUG: Layout dos filtros de Relatórios - campos sobrepostos (empresa e tipo ficam um sobre o outro)
- [x] Relatório completo: adicionar campos de tributação municipal (ISSQN, alíquota, BC, retenção, município incidência)
- [x] Relatório completo: adicionar campos de tributação federal (IRRF, CSLL, PIS, COFINS, retenções)
- [x] Relatório completo: adicionar totais aproximados de tributos (federais, estaduais, municipais)
- [x] Relatório completo: indicação clara de retenção (tem/não tem) com destaque visual
- [x] Relatório completo: informações complementares da nota
- [x] Relatório completo: gráficos modernos (distribuição por tipo, valores, retenções)
- [x] Relatório tela: redesign com layout expandido mostrando todos os campos
- [x] Relatório Excel: todas as colunas de tributação e retenção nas 3 abas
- [x] Relatório completo: procedure getData retorna dados completos do XML (parseNfseXmlCompleto)
- [x] Relatório completo: procedure exportExcel com todas as colunas de tributação
- [x] Relatório tela: redesign com abas Resumo, Detalhes, Tributação e gráficos modernos
- [x] Relatório tela: modal de detalhes completos da nota ao clicar em uma linha
- [x] Testes: parseNfseXmlCompleto e procedure de relatório (18 testes, 173 total)
- [x] BUG: Download ZIP geral não funciona - erro "Storage proxy credentials missing"
- [x] Download ZIP deve gerar a partir dos XMLs já salvos no banco (sem dependência de S3/storage proxy)
- [x] Download ZIP deve funcionar com volume grande de arquivos (3000+ notas)
- [x] Downloads devem persistir entre sessões (sair e voltar ao sistema)
- [x] Adicionar checkboxes de seleção no histórico de downloads (selecionar tudo ou individual)
- [x] Botão ZIP deve gerar apenas dos selecionados
- [x] Admin: editar cadastro completo do contador (todos os campos) - já implementado
- [x] Admin: trocar senha do contador - já implementado
- [x] Admin: trocar plano do contador - já implementado
- [x] Admin: excluir contador - já implementado
- [x] BUG CRÍTICO: Downloads travados com 200+ empresas - sistema fica preso em "iniciando"
- [x] Refatorar engine de download: fila robusta com controle de concorrência configurável
- [x] Implementar worker queue com semáforo para limitar chamadas simultâneas à API
- [x] Adicionar timeouts individuais por empresa e mecanismo de circuit breaker
- [x] Melhorar feedback de progresso durante downloads em massa
- [x] Garantir que downloads não bloqueiem o event loop do Node.js
- [x] Finalizar correção ZIP base64 (sem S3)
- [x] Adicionar checkboxes de seleção no histórico de downloads
- [x] BUG CRÍTICO: Downloads não iniciam - ficam travados "Na Fila" com 0 em execução (engine v3 reescrito)
- [x] Reescrever completamente o fluxo de download para funcionar 100% (engine v3 worker pool)
- [x] Adicionar coluna de numeração (#) na tabela do histórico de downloads
- [x] Card de progresso: mostrar quantos na fila, quantos baixando, quantos concluídos
- [x] Simplificar configurações de download - consolidar em card único "Velocidade de Download"
- [x] Ordenar histórico: concluídos no topo, depois em andamento, depois aguardando na fila
- [x] BUG CRÍTICO: Downloads ainda não iniciam - causa: concorrência default era 1, agora é 3
- [x] Filtrar certificados vencidos do download (executeForAll já filtrava, executeForSelected agora também filtra)
- [x] Mostrar TODOS os downloads - limite aumentado para 1000
- [x] Paginação configurável: 10-200 ou digitar até 1000
- [x] BUG: Downloads duplicados - mesma empresa aparece mais de uma vez na lista de downloads (deduplicar por CNPJ)
- [x] BUG: Downloads duplicados - deduplicar por CNPJ (executeForAll e executeForSelected agora deduplicam)
- [x] Card de resumo completo: bem sucedidos, com erro, sem notas, retomando, total XMLs/PDFs baixados
- [x] CRÍTICO: Filtro de competência na consulta à API Nacional - não baixar todas as notas, apenas do período selecionado
- [x] Garantir que clientes com 30mil+ notas não travem o sistema ao consultar apenas o período desejado
- [x] BUG CRÍTICO: ZIP Todas (119 empresas, 19mil+ XMLs) dá timeout/erro "Unexpected token" - reescrever para geração assíncrona com upload S3
- [x] BUG: Card de resumo mostra dados incoerentes (Total=1, Sucesso=0 quando deveria ser Sucesso=1) - corrigir lógica de contagem
- [x] Adicionar cabeçalho de resumo nos relatórios PDF e Excel (total empresas, sucesso, sem notas, erros, XMLs, PDFs, tempo)
- [x] Relatórios Excel dentro do ZIP: dados completos das notas (conforme exemplo XLSX do usuário) com todos os campos fiscais extraídos do XML
- [x] CRUD completo de usuários no admin: criar, editar, excluir usuários
- [x] Trocar senha de qualquer usuário (somente admin)
- [x] Poder criar usuários admin
- [x] Definir papel (admin/contabilidade/usuario) e contabilidade associada ao criar/editar
- [x] BUG: Botão ZIP na página Downloads dá erro "Nenhuma nota encontrada para este cliente" - agora mostra mensagem informativa
- [x] BUG: Card de resumo mostra TOTAL=1 empresa e SUCESSO=0 - corrigido: agora filtra apenas logs do lote atual
- [x] Dashboard: gráficos clicáveis - clicar em um mês filtra todos os dados para aquele período
- [x] Dashboard: Top Clientes dinâmico - atualiza conforme mês selecionado
- [x] Dashboard: gráficos de pizza e totais dinâmicos por período selecionado
- [x] Dashboard: botão "Ver Todos" - modal/janela com todos os clientes e valores completos
- [x] Dashboard: relatório PDF com gráficos bonitos (total, por empresa, por período)
- [x] Dashboard: relatório Excel com gráficos (total, por empresa, por período)
- [x] Logout deve redirecionar à página inicial (landing page) sem formulário de login visível
- [x] BUG: ZIP Selecionadas (165 empresas) dá erro "Unexpected token '<', '<html>... is not valid JSON'" - corrigir geração de ZIP em massa
- [x] Melhoria: Adicionar barra de progresso visual durante geração do ZIP (percentual, empresas processadas, tempo estimado)
- [x] Melhoria: Geração assíncrona do ZIP com feedback em tempo real para o usuário saber que está funcionando
- [x] Admin: campo "Retenção de dados" por contador (quantos meses manter XMLs/PDFs baixados)
- [x] ZIP: filtro de período para gerar ZIP apenas das notas já baixadas dentro do período escolhido
- [x] ZIP individual (por empresa): respeitar filtro de período da tela de Downloads
- [x] ZIP Selecionadas: respeitar filtro de período (notas já baixadas no período)
- [x] ZIP assíncrono: passar período para a procedure iniciarZipTodas
- [x] BUG: Ícones/emojis nos cards de estatísticas do relatório de histórico aparecem como símbolos danificados (%, &, %Ë, %¶, etc.)
- [x] ZIP: Modal de seleção de período ao clicar em ZIP (individual ou selecionadas) — mostra períodos disponíveis no banco
- [x] ZIP: Procedure backend para listar períodos disponíveis (meses com notas) por cliente(s)
- [x] ZIP: Após selecionar período e confirmar, mostrar progresso com período selecionado visível
- [x] BUG: Dashboard filtro por mês (ex: Outubro 2025) zera todos os dados - Clientes 0, Notas 0, gráficos vazios
- [x] BUG: Relatório PDF do Dashboard só mostra 20 clientes, deveria listar todos
- [x] BUG: Card "Valor Total" no PDF do Dashboard tem textos amontoados/sobrepostos (R$ e Valor Total)
- [x] Melhoria: Modal "Ver Todos" - valores Emitido/Recebido cortados, melhorar layout
- [x] BUG: Modal "Selecionar Período para ZIP" mostra "Nenhuma nota encontrada" mesmo com notas baixadas - procedure periodosDisponiveis não está encontrando as notas
- [ ] Relatórios: Excel moderno e dinâmico com cabeçalho LAN7-Pegasus, cards de resumo, gráficos dinâmicos e tabela completa
- [ ] Relatórios: Gráficos no Excel - barras (notas por mês, por empresa), pizza (status, tipo), linha (variação mensal)
- [ ] Relatórios: Abas no Excel para Relatório, Tributação, Gráficos e Multi-Empresa
- [ ] Relatórios: Formatação profissional azul-escuro estilo dashboard
- [x] Excel profissional: Dashboard e Relatório com cabeçalho LAN7-Pegasus, cards de resumo coloridos, gráficos dinâmicos (barras, pizza, linha, empilhadas), múltiplas abas (Relatório, Geral, Emitente, Tomador, Tributação), filtros automáticos, linhas de totais e bordas
- [x] BUG: Divergência de valores ISSQN entre XML original, PDF DANFE e planilha Excel — investigar parser e corrigir em todos os relatórios
- [x] Análise minuciosa: comparar TODOS os campos do parser XML com PDF DANFE e corrigir divergências
- [x] Correção: tpRetISSQN invertido (1=Não Retido, 2=Retido pelo Tomador, 3=Retido pelo Intermediário)
- [x] Correção: alíquota não encontrada (pAliqAplic vs pAliq)
- [x] Correção: ISSQN Retido não calculado quando tpRetISSQN=2
- [x] Correção: valor do serviço não encontrado em todos os caminhos XML
- [x] Correção: tributos aproximados (federais/estaduais/municipais) zerados
- [x] Verificar e corrigir Excel relatório, Excel dashboard e demonstrativos online
- [x] Criar teste unitário com XML real para validar 100% dos campos
- [x] ZIP: 4º relatório Excel "Emitidas + Canceladas" combinando notas emitidas e canceladas com coluna Status visível
- [x] BUG: Nota 768 - IRRF e Contribuições Sociais Retidas não aparecem na planilha Excel do ZIP — corrigir parser para extrair todos os campos tributários federais
- [x] Reverter parser para formato anterior (mais claro) mantendo correções de IRRF/CSLL/ISSQN
- [x] Acrescentar campos CST PIS/COFINS, Base Cálc. PIS/COFINS, Alíquota PIS, Alíquota COFINS, Código NBS e Cód. Interno Contribuinte ao parser e relatórios Excel
- [x] BUG: Campos UF Tomador, Telefone Tomador e Cód. Trib. Municipal vazios na planilha Excel — corrigido: UF resolvido via código IBGE; Telefone e Cód. Trib. Municipal ausentes no XML original
- [ ] Atualizar manual do usuário com novas funcionalidades e screenshots reais do programa
- [x] Adicionar logo Pegasus NFe como marca d'água centralizada no card de login da landing page
- [x] Adicionar marca d'água da logo Pegasus em todos os relatórios PDF (exceto Excel)
- [x] Aumentar destaque da logo + nome Pegasus no header da landing page
- [x] Botão "Apagar Todos os Clientes" deve apagar TUDO de TODAS as tabelas do banco (notas, certificados, downloads, agendamentos, histórico, etc.) - limpeza completa
- [x] Agendador: campos de data inicial e data final para escolher período das notas a baixar
- [x] Agendador: campos Data Inicial e Data Final para escolher período das notas a baixar (igual tela de Downloads)
- [x] Scheduler server-side: agendamentos devem funcionar mesmo com navegador/página fechados (cron no backend)
- [x] BUG: Scheduler não dispara agendamentos - corrigido fuso horário (servidor EST vs usuário BRT/GMT-3)
- [x] BUG: Agendamento não termina de baixar e parece estar repetindo downloads - corrigido: timezone UTC na conexão DB + proteção contra duplicação
- [x] Agendamentos: editar agendamento existente (horário, frequência, período, cliente) sem precisar excluir e recriar
- [x] BUG: Agendamento usa método diferente do download manual - corrigido: agora passa competenciaInicio/competenciaFim + dataInicio/dataFim igual ao frontend
- [x] Login Admin fixo (chumbado) no banco de dados para acesso após implantação sem depender do OAuth
- [x] BUG: "Apagar Todos os Clientes" não apaga as notas fiscais - corrigido: agora apaga diretamente por contabilidadeId com verificação final e fallback SQL
- [x] BUG CRÍTICO: Agendamento duplicando empresas (334 vs 167 manual) - corrigido: lock por contabilidade impede downloads simultâneos da mesma contabilidade
- [x] OTIMIZAÇÃO: Downloads lentos - corrigido: 5 workers (antes 3), delays reduzidos (500ms entre workers, 300ms entre páginas API, 1s retry PDF), timeout 3min
- [x] BUG CRÍTICO: "Apagar Todos os Clientes" AINDA não funciona - corrigido definitivamente: (1) cancela downloads em andamento ANTES de apagar, (2) SQL direto como método primário, (3) verificação final + retry agressivo, (4) aguarda workers detectarem cancelamento
- [ ] BUG CRÍTICO: "Apagar Todos" apaga clientes mas NÃO apaga notas - notas ficam órfãs (14 notas, R$59k visíveis com 0 clientes)
- [x] BUG CRÍTICO: "Apagar Todos" apaga clientes mas NÃO apaga notas - notas ficam órfãs (workers re-criam notas após deleteAll)
- [x] CORREÇÃO RAIZ: isDownloadCancelled retorna TRUE quando log não existe (deletado) - workers param imediatamente
- [x] CORREÇÃO: deleteAll com loop agressivo de 10 tentativas + 5s de espera para workers pararem + re-cancelamento
- [x] Auto-retomada travando: 33 empresas paradas em "aguardando" porque processa sequencialmente e 1 empresa trava tudo
- [x] Reescrever auto-retomada com Download Engine (paralelo), empresas com problema vão pro fim da fila, repete até zerar
- [x] Nunca travar em nenhuma circunstância: timeout → fim da fila, continua restante
- [x] Resumo em Tempo Real zerado após restart/recovery: batchSummary agora inclui logs ativos independente do timestamp
- [x] Barra de auto-retomada mostrando '0 de 34' parado: agora mostra rodada, pendentes e retomados reais
- [x] BUG: Resumo em Tempo Real mostra Total=19 mas Sucesso=0, XMLs=0, PDFs=0 - corrigido: removido filtro de timestamp (timezone MySQL vs JS)
- [x] BUG: Auto-retomada mostra "34 empresa(s) na fila" sem progresso - corrigido: callback onTaskComplete atualiza status em tempo real
- [x] BUG: Cards de "Retomando" não mostram barra de progresso - corrigido: auto-retomada usa Download Engine paralelo com status real
- [x] BUG: Relatório PDF com várias páginas em branco - corrigido: lineBreak:false no rodapé + watermark inline
- [x] BUG: Resumo em Tempo Real zerado após recovery - corrigido: removido filtro de timestamp, usa todos os logs ativos
- [x] Painel de configurações avançadas de download em Ferramentas: timeout, workers, rodadas, delays com indicações de melhores práticas
- [x] Botão "Usar Melhores Práticas" nas configurações: aplica valores recomendados da API vs modo personalizado
- [x] Reorganizar aba Ferramentas: 4 cards básicos (Tentativas PDF, Download PDFs, Velocidade, Auto-Retomada) em grid 2 colunas lado a lado
- [x] Configurações Avançadas: resumo compacto em grid 3 colunas + modo personalizado com grid 2 colunas
- [x] Configurações Ferramentas: opção "Retomada Infinita" - sistema continua retomando automaticamente até que todas as empresas estejam sem erros
- [x] Backend: lógica de loop de retomada que repete até 0 erros, respeitando delay configurado entre rodadas
- [x] Frontend: toggle/opção na aba Ferramentas para ativar retomada infinita vs rodadas limitadas
- [x] BUG: Download não respeita período selecionado - corrigido: período agora é salvo no log e lido em TODAS as retomadas (retry, retryAll, auto-retomada, retomada infinita, recovery)
- [x] Verificar se parâmetros de data (dataInicio/dataFim) estão sendo enviados corretamente à API NFSe
- [x] Schema: campos modo, competenciaInicio, competenciaFim, periodoDataInicio, periodoDataFim na tabela download_logs
- [x] Backend: extractPeriodoFromLog helper para ler período salvo no log
- [x] Backend: TODOS os createDownloadLog agora salvam o período original
- [x] Backend: TODAS as retomadas (9 pontos) agora leem e passam o período do log
- [x] Testes: 235 testes passando (15 novos testes para período em retomadas)
- [x] BUG: Auto-retomada rodando sem downloads para retomar - histórico vazio mas mostra "Rodada 1: 3 empresa(s) na fila" - corrigido: deleteAll limpa status + getAutoRetomadaStatus verifica se existem downloads reais
- [x] BUG: Cards das empresas em download piscam (aparecem e somem) durante o processamento — corrigido com placeholderData para manter dados anteriores durante refetch
- [x] BUG: Default de workers desalinhado: frontend mostra 3, engine usava 5 — corrigido: ambos agora usam default 3
- [x] BUG: Auto-retomada marca TODAS as empresas como 'retomando' de uma vez (45 cards) — corrigido: agora marca como 'pendente' (na fila) e o engine muda para 'executando' conforme processa (respeitando limite de 3 simultâneas)
- [x] BUG URGENTE: Frontend mostrava '0 executando' por timing do polling — corrigido: frontend agora usa batchSummary do engine (tempo real) + placeholderData para manter cards visíveis
- [x] BUG: Cards de download mostram apenas 1 empresa — corrigido: engine agora salva activeLogIds (IDs exatos dos logs ativos) no status, frontend usa esses IDs para renderizar os cards corretos
- [x] Período relativo no agendador: adicionar campos periodoTipo e periodoDias no schema
- [x] Período relativo no agendador: backend calcula datas dinamicamente na execução
- [x] Período relativo no agendador: frontend com toggle Data Fixa / Últimos X dias
- [x] Período relativo no agendador: prévia visual do período calculado no formulário
- [x] Skip de notas já baixadas: verificar chaveAcesso no banco antes de baixar cada nota
- [x] Skip de notas já baixadas: atualizar contadores e progresso com notas puladas
- [x] Skip de notas já baixadas: mostrar feedback visual no card (X já baixadas, baixando restantes)
- [x] Bug: Cards de download em andamento não aparecem durante retomada infinita
- [x] Adicionar contador visual estilo cronômetro/gauge moderno com anel de progresso no resumo do histórico
- [x] Sistema de temas: criar CSS variables para tema escuro futurista e claro futurista
- [x] Sistema de temas: criar contexto React de tema com persistência no banco
- [x] Sistema de temas: adicionar seletor de tema na sidebar do dashboard
- [x] Sistema de temas: adaptar DashboardLayout e sidebar para usar variáveis de tema
- [x] Sistema de temas: adaptar páginas do dashboard (Histórico, Agendamentos, etc) para tema
- [x] Refazer temas: pesquisar referências de temas modernos de dashboard na internet
- [x] Refazer temas: implementar 3 temas profissionais de alta qualidade
- [x] Refazer temas: ajustar todas as páginas e componentes para ficarem perfeitos nos 3 temas
- [x] Agendamento por dia útil: remover seletor de mês fixo, rodar todo mês no Xº dia útil automaticamente
- [x] Agendamento por dia útil: prévia mostra próximo dia útil do mês atual/próximo
- [ ] Bug: Botão 'Parar Downloads' não funciona — download continua mesmo após clicar várias vezes
- [x] Tema escuro: refazer inspirado no design Dhanesh T S (Dribbble) - fundo #0d1117, sidebar dark, cards glassmorphism, gráficos neon
- [x] Exclusão individual de cliente no painel Meus Clientes deve apagar TUDO em cascata: certificados, notas fiscais, downloads, histórico de downloads, agendamentos e todos os dados vinculados
- [x] Visual futurista: cards flutuantes com sombra colorida (glow) em todas as páginas do dashboard
- [x] Visual futurista: gráficos com gradiente de preenchimento (fade cor → transparente) no dashboard
- [x] Visual futurista: efeito de profundidade com múltiplas camadas visuais e bordas brilhantes
- [x] Visual futurista: sidebar com visual dark premium e item ativo com glow
- [x] Visual futurista: KPI cards com números grandes, gradientes e efeito de brilho
- [x] BUG: Gráfico de barras - fundo cinza aparece ao passar o mouse (cursor/hover cinza do Recharts)
- [x] BUG: Gráfico de pizza - tooltip com texto escuro sobre fundo escuro, impossível de ler no dark mode
- [x] Melhoria: Aumentar intensidade dos efeitos visuais futuristas (glows, sombras, gradientes mais aparentes)
- [x] BUG: Card de cabeçalho da nota no Visualizar XML está com fundo esverdeado fora do padrão — padronizar com cinza escuro igual aos demais cards do sistema
- [x] BUG: Nomes das empresas nos cards de download em andamento impossíveis de ler no dark mode — mudar para azul neon claro quase branco
- [x] BUG: Texto "Processando: NOME DA EMPRESA" sai para fora do card de geração de ZIP — truncar nome longo
- [x] BUG: Texto da empresa ainda sai para fora do card ZIP — aumentar largura do card e forçar overflow
- [x] Adicionar botão de cancelar processo de download ZIP no card de geração
- [x] CT-e: Criar tabelas no banco (cte_notas, cte_download_logs, cte_nsu_control)
- [x] CT-e: Implementar cliente SOAP CTeDistribuicaoDFe no backend
- [x] CT-e: Criar procedures tRPC para download, consulta e histórico de CT-e
- [x] CT-e: Criar página CT-e Downloads (iniciar download por empresa, progresso)
- [x] CT-e: Criar página CT-e Notas (listar, filtrar, visualizar CT-e baixados)
- [x] CT-e: Criar página CT-e Histórico (histórico de downloads com status)
- [x] CT-e: Integrar páginas na sidebar e rotas do App.tsx
- [x] CT-e: Adicionar grupo "CT-e" na sidebar do menu lateral com itens separados
- [ ] CT-e: Download de PDF (DACTE) junto com XML
- [x] CT-e: Criar página de Relatórios CT-e no padrão dos relatórios NFSe
- [ ] CT-e: Opção em Configurações para escolher baixar ou não o PDF (DACTE), igual ao NFSe
- [ ] CT-e: Admin deve poder habilitar/desabilitar módulo CT-e por contador
- [x] Admin: Toggle para habilitar/desabilitar módulo CT-e por contabilidade na tela de edição
- [x] Admin: Toggle para habilitar/desabilitar download de PDF (DACTE) do CT-e por contabilidade
- [x] BUG: Nome da contabilidade no topo da sidebar invisível no tema escuro — corrigir para todos os temas
- [x] CT-e: Melhorar feedback de download — mostrar mensagem clara quando não há CT-e disponível
- [x] CT-e: Garantir que o card de progresso mostre status final correto (concluído com X notas ou "nenhum CT-e encontrado")
- [x] CT-e: Adicionar detalhes da resposta SEFAZ no log de download (cStat, xMotivo)
- [x] BUG: CT-e Downloads - erro "Cannot read properties of undefined (reading 'length')" no frontend
- [x] BUG: CT-e Downloads - erro "Cannot read properties of undefined (reading 'length')" na linha 38 - data.logIds é undefined para executeForCliente (retorna logId, não logIds)
- [x] CT-e Downloads: Adicionar opção de download por período (data inicial/final) além do mês a mês
- [x] CT-e Downloads: Redesenhar com tabs separadas - seleção de empresas vs acompanhamento de downloads (cards/lista)
- [x] CT-e Downloads: Botão "Parar Todos" para cancelar todos os downloads em andamento
- [x] CT-e: Botão para baixar ZIP com XMLs organizados em pastas + relatórios (igual NFSe) [backend pronto, frontend pendente]
- [x] CT-e Downloads: KPI cards em tempo real na aba Acompanhar (CT-e baixados, erros, em andamento, concluídos, sem CT-e)
- [x] BUG: CT-e Downloads - Botão "Parar Todos" desaparece quando não há downloads em andamento, precisa ficar visível
- [x] CT-e Downloads: Botão "Limpar Lista" para remover finalizados/cancelados da tela
- [x] BUG CRÍTICO: CT-e cStat 215 (Rejeição: Falha no esquema XML) - corrigido: versao 1.00→1.01 + campo cUFAutor adicionado + UF dinâmica por empresa
- [x] BUG: CT-e "Parar Todos" corrigido - usa cancelAllDownloads do backend + limpa lista imediatamente
- [x] BUG: CT-e cStat 239 (Rejeição: versão do arquivo XML não suportada) - corrigido: cteCabecMsg + versao 1.00 + namespaces xsi/xsd
- [ ] BUG: CT-e Downloads frontend mostra apenas 11 finalizados enquanto backend processou 192+ empresas - polling não reflete progresso real
- [ ] CT-e Downloads: Implementar processamento concorrente (múltiplas empresas simultâneas) em vez de sequencial
- [ ] CT-e Relatórios: Botão "Relatório Excel" (exportar .xlsx com filtros aplicados)
- [ ] CT-e Relatórios: Botão "Relatório PDF" (exportar .pdf com resumo)
- [ ] CT-e Relatórios: Botão "Baixar ZIP (Empresa)" com seletor de empresa - pastas Autorizadas/Canceladas/Denegadas
- [ ] CT-e Relatórios: Botão "Baixar ZIP (Todos)" consolidado com pasta por empresa - subpastas Autorizadas/Canceladas/Denegadas
- [ ] Backend: Atualizar procedures gerarZipCliente e gerarZipMultiplos para usar pastas por status (Autorizadas/Canceladas/Denegadas)
- [ ] Backend: Criar procedure gerarRelatorioPdfCte para gerar PDF com resumo
- [ ] Backend: Criar procedure gerarRelatorioExcelCte para exportar Excel com filtros
- [ ] Agendamentos: Adicionar campo tipo documento (NFe, CT-e, Ambos) no schema e backend
- [ ] Agendamentos: Seletor de tipo documento no formulário de criação/edição
- [ ] Agendamentos: Executar download CT-e quando agendamento for do tipo CT-e ou Ambos
- [x] CT-e Downloads: Botão "Atualizar CT-e" que baixa apenas novos (usando último NSU)
- [x] Ferramentas: Apagar dados deve incluir CT-e (notas, logs, NSU)
- [x] Excluir Cliente: Incluir exclusão de dados CT-e (notas, logs, NSU) em cascata
- [x] BUG: CT-e Downloads trava com 65 em andamento - processNext() reescrito com workers robustos
- [ ] CT-e Downloads: Ordenar downloads em andamento no topo da lista
- [ ] CT-e Recovery: Adicionar recovery de downloads CT-e órfãos ao iniciar servidor
- [ ] CT-e Downloads: Botão "Retomar" individual em cada card com erro
- [ ] CT-e Downloads: Botão "Retomar Todos" para retentar todos os downloads com erro
- [ ] CT-e: Seção CT-e em Ferramentas (auto-retomada, retomada infinita, configurações)
- [ ] CT-e Recovery: Marcar downloads CT-e órfãos como erro ao reiniciar servidor
- [ ] BUG: Atualizar CT-e (só novos) não funciona - erro "Nenhum cliente possui CT-e baixados" mesmo com CT-e já baixados (NSU não salvo na tabela cte_nsu_control)
- [ ] DACTE: Baixar DACTE oficial do portal SEFAZ (cte.fazenda.gov.br) usando chave de acesso
- [ ] DACTE: Botão "Ver DACTE" na tela CT-e Notas para visualizar no painel
- [ ] DACTE: Incluir DACTEs nos ZIPs de download junto com XMLs
- [x] CT-e Relatórios: Filtro por cliente (empresa) nos relatórios
- [x] CT-e Relatórios: Tabela Resumo por Cliente com qtd CT-e, valor total, ICMS por status
- [ ] CT-e Relatórios: Relatório Excel/PDF por cliente individual
- [x] DACTE: Reescrever cte-dacte.ts com layout oficial SEFAZ completo (QR Code, código de barras, todas as seções)
- [x] DACTE: Adicionar seção Pesos e Volumes (Peso Bruto, Base Cálculo, Cubagem, Qtd Volumes)
- [x] DACTE: Adicionar seção Previsão do Fluxo da Carga
- [x] DACTE: Adicionar seção Tomador do Serviço separada
- [x] DACTE: Melhorar Documentos Originários com formato DOC/CNPJ/CPF/CHAVE/SÉRIE
- [x] CT-e Scheduler: Implementar executeCteDownloadForScheduler no scheduler
- [x] BUG: DACTE PDF gera erro "switchToPage() out of bounds, current buffer covers pages 74 to 74" - corrigir geração PDFKit (era no cte-pdf-report.ts, não no DACTE)
- [x] BUG: Exportação Excel/PDF CT-e ignora filtro de empresa - deve exportar apenas dados da empresa selecionada
- [x] BUG: PDF CT-e erro switchToPage out of bounds - faltava bufferPages:true (corrigido)
- [x] BUG: PDF CT-e gera páginas em branco extras - rodapé switchToPage cria páginas vazias (corrigido com lineBreak:false)
- [x] BUG: Filtro empresa nos relatórios CT-e não filtra corretamente - clienteId agora passado para Excel/PDF/ZIP
- [x] Relatórios CT-e dinâmicos: Excel/PDF/ZIP respeitam TODOS os filtros + nome do arquivo dinâmico + filtros exibidos no cabeçalho do PDF
- [x] Página inicial: Atualizar textos para mencionar CT-e além de NFSe (título, descrição, funcionalidades)
- [x] BUG: Landing page afetada pelo tema do usuário - tema fixo definido pelo admin via Configurações
- [x] Atualizar textos da landing page no banco de dados para incluir CT-e
- [x] Relatórios CT-e: Excel com todos os campos do XML + 4 abas (Detalhado 41 colunas, Resumo Emitente, Resumo Modal, Resumo Status)
- [x] Relatórios CT-e: PDF com 16 colunas (incl. CFOP, tomador, produto, peso, placa)
- [ ] Relatórios CT-e: ZIP deve organizar por empresa com subpastas (autorizados, cancelados, denegados)
- [x] DACTE: Botão "Ver DACTE" na tela CT-e Notas para visualizar/download do PDF (já existe)
- [x] DACTE: Incluir DACTEs nos ZIPs de download junto com XMLs (já existe)
- [x] BUG CRÍTICO: DACTE gerado sem dados - corrigido: XML base64+gzip não era decodificado antes do parse
- [x] DACTE: Parser XML funciona corretamente - problema era decodificação base64+gzip
- [x] DACTE: Layout fiel ao documento oficial SEFAZ com todos os dados preenchidos
- [x] DACTE: Layout melhorado com QR Code, número formatado, VALOR ICMS ST, texto legislação, data impressão
- [x] DACTE: ICMS correto - situação tributária código+descrição, base cálculo, alíquota, valor, % RED BC, ICMS ST
- [x] DACTE: Layout ajustado com labels corretos (PESO AFERIDO, SITUAÇÃO TRIBUTÁRIA), formatação de números e VALOR ICMS ST
- [x] CT-e Notas: Adicionar filtro por Cliente (empresa do certificado cadastrado) na tela de consulta
- [ ] DACTE: Corrigir layout para ficar idêntico ao meudanfe.com.br - falta QR Code, VALOR ICMS na seção impostos, número formatado com pontos, labels corretos
- [ ] DACTE: Seção Expedidor/Recebedor com layout correto (labels ENDEREÇO, MUNICÍPIO, CNPJ/CPF, IE, FONE, PAÍS)
- [ ] DACTE: Seção Tomador com layout correto (ENDEREÇO, MUNICÍPIO, UF, CEP, CNPJ/CPF, IE, PAÍS, FONE)
- [ ] DACTE: Adicionar QR Code grande ao lado do código de barras no cabeçalho
- [ ] DACTE: Número formatado com pontos (162.971.128) e "Nº." prefix
- [ ] CT-e ZIP: Opção de download com ou sem PDF (DACTE) - checkbox na interface
- [ ] CT-e ZIP: Incluir um PDF DACTE para cada XML no ZIP quando opção ativada
- [x] CT-e Notas: Coluna "Cliente" na tabela entre Número e Emissão mostrando razão social da empresa
- [x] CT-e Notas: JOIN com tabela clientes para trazer razão social e CNPJ do cliente
- [x] CT-e Notas: Busca por CNPJ do cliente e nome da empresa (razão social) no campo de busca
- [x] CT-e Notas: Busca por número do CT-e no campo de busca
- [x] CT-e Notas: Modal de detalhes mostra Cliente (Empresa) com destaque visual
- [x] CT-e Notas: Mostrar chaves das NF-e (DANFe) vinculadas ao CT-e na tabela e modal de detalhes
- [x] CT-e Relatórios: Incluir chaves NF-e nos relatórios Excel e PDF (já existia no Excel)
- [x] CT-e Notas: Botão/link para abrir DANFe no meudanfe.com.br pela chave NF-e (visualização online)
- [ ] BUG: DACTE - Seção Documentos Originários deve mostrar campos (TIPO DOC, CNPJ/CHAVE/OBS, SÉRIE/NRO. DOCUMENTO) em duas colunas lado a lado, mesmo quando vazios
- [ ] BUG: Coluna NF-e na tabela CT-e Notas mostra "-" quando deveria exibir as chaves NF-e vinculadas
- [x] Botão que abre meudanfe.com.br com chave NF-e preenchida automaticamente (via URL direta)
- [x] CT-e Notas Ações: Botão MeuDanfe para abrir chave de acesso do CT-e no meudanfe.com.br
- [x] CT-e Notas Modal: Botão MeuDanfe no modal de detalhes (ao lado de Ver XML e Ver DACTE)
- [x] Procedure backend para repopular chavesNfe dos XMLs existentes no banco
- [x] DACTE: Seção Documentos Originários com pelo menos 4 linhas com bordas (mesmo vazias)
- [x] Ferramentas: Botão para apagar todos os dados de CT-e (notas, downloads, NSU) sem afetar NFe
- [x] Ferramentas: Botão para apagar todos os dados de NFe (notas, downloads) sem afetar CT-e
- [x] Auditoria: Registrar todas as atividades dos usuários (login, logout, downloads, exclusões, criação de agendamentos, visualizações)
- [x] Auditoria: Campo para configurar tempo de armazenamento dos logs de auditoria (30, 60, 90, 180 dias)
- [x] Agendamento: Permitir agendamento de download de CT-e separado do NFe
- [x] NFe Relatórios: Mover botão visualizar (olho) para depois da coluna Status
- [ ] NFe Modal: Melhorar layout do modal de detalhes da NFSe
- [ ] NFe Modal: Adicionar botão para abrir/visualizar PDF da NFe
- [x] NFe DANFSe: Modal do PDF deve ser maior e ter opção de tela cheia
- [x] UI: Corrigir cor do badge "Expirando" (amarelo ilegível) em todas as telas
- [ ] DACTE: Corrigir alinhamento, espaçamento e textos amontoados em todas as seções do PDF
- [x] CT-e Notas: Ao clicar no badge NF-e, verificar se a NF-e já foi baixada no sistema e abrir visualização interna em vez de redirecionar para meudanfe.com.br
- [x] NFe Notas: Corrigir cor do badge "Recebida" na coluna Direção (ilegível no tema escuro)
- [x] Histórico Downloads: Corrigir cor do badge "Sem notas" na coluna Status (ilegível no tema escuro)
- [x] NFe Relatórios: Corrigir cor do badge "Receb." na coluna Tipo (ilegível no tema escuro)
- [x] DACTE PDF: Corrigir textos amontoados na Identificação do Emitente, adicionar padding interno nos campos, corrigir Tomador mostrando tag XML, e melhorar espaçamento geral
- [x] CT-e Download ZIP: Adicionar opção para escolher se quer baixar PDFs (DACTE) junto com os XMLs no momento do download
- [x] CT-e Relatórios: Corrigir campo Empresa no filtro - texto cortado por falta de largura no select
- [x] CT-e Relatórios: Adicionar coluna Nome do Cliente antes da coluna Emitente na tabela Resumo por Emitente
- [x] CT-e Downloads: Corrigir erro no botão "Atualizar CT-e (só novos)" que retorna HTML em vez de JSON
- [x] CT-e Notas: Corrigir campo Cliente no filtro sobrepondo campo Status (texto amontoado)
- [x] CT-e Downloads Acompanhar: Animação de loading no card "Em Andamento" continua rodando mesmo quando todos os processos já finalizaram
- [x] CT-e Notas: Aumentar largura e altura do modal de detalhes para visualização mais confortável
- [x] CT-e Notas: Adicionar todos os campos de impostos e valores no modal de detalhes (ICMS ST, Base Cálculo, Alíquota, etc.)
- [x] Aplicar melhorias de tamanho em todos os modais/popups similares do sistema
- [x] CT-e Downloads Acompanhar: Botão "Atualizar" sem função aparente e sem feedback visual ao clicar
- [x] Global: Corrigir checkboxes invisíveis no modo escuro - aplicar bordas neon azul com branco em todos os checkboxes
- [ ] Global: Aumentar todos os popups/modais de informação para near-fullscreen (ocupar quase toda a tela)
- [ ] Expandir modal CT-e detalhes para near-fullscreen com layout horizontal otimizado
- [ ] Expandir modal XML CT-e para near-fullscreen
- [ ] Expandir modal NF-e vinculadas para near-fullscreen
- [ ] Expandir modal PDF/DANFSe NFSe para near-fullscreen
- [ ] Expandir modal XML NFSe para near-fullscreen
- [ ] Expandir modal detalhes Relatórios NFSe para near-fullscreen
- [ ] Reorganizar conteúdo dos modais para distribuir horizontalmente sem barra de rolagem
- [x] Remover ícone FileSearch (Ver NF-e) das chaves NF-e vinculadas no modal CT-e detalhes
- [x] Permissões CT-e: adicionar campos verCteNotas, fazerDownloadsCte, verHistoricoCte, verRelatoriosCte no schema
- [x] Permissões CT-e: checkboxes no modal de permissões do frontend
- [x] Permissões CT-e: verificar permissões nas procedures de CT-e
- [x] Permissões CT-e: esconder menus CT-e no sidebar baseado nas permissões
- [ ] Auditoria: registrar todas as ações do sistema (não apenas exclusões)
- [ ] Auditoria PDF: separar registros por usuário com linha de início e final no relatório
- [x] Dashboard: comprimir cards ~10% mais juntos, levantar gráficos
- [ ] Tema: criar tema intermediário (cinza/meio-termo entre claro e escuro)
- [ ] Logo Pegasus como marca d'água no modal de detalhes CT-e (área superior)
- [ ] Logo Pegasus como marca d'água em todos os relatórios PDF que ainda não têm
- [ ] Relatórios certificados: botões PDF e Excel na tela Certificados e Validade Certificados
- [ ] Relatórios certificados: filtro por status (vencidos, a vencer 30d, a vencer 60d, válidos)
- [ ] Relatórios certificados: procedure backend para gerar Excel e PDF dinâmicos
- [x] Expandir modal "Baixar ZIP - Selecionar Empresa" para ficar mais largo
- [x] Adicionar campo de pesquisa (CNPJ/nome) no modal "Baixar ZIP - Selecionar Empresa" do CteRelatorios
- [ ] Corrigir cores de texto/badges: badges "Expirando" com texto ilegível (amarelo/branco)
- [ ] Corrigir cores de texto/badges: badges "Válido" ilegíveis no tema claro (Validade Certificados)
- [ ] Corrigir cores de valores no CT-e Relatórios para melhor contraste no tema claro
- [ ] Efeito neon glow nos textos do menu lateral (sidebar) no tema escuro
- [x] Fix download incremental: não reprocessar todas as 328 empresas quando modo incremental
- [x] BUG: Download incremental "Somente novas" processando todas as empresas em vez de pular as sem notas novas
- [x] BUG: Histórico de downloads duplicando registros no modo incremental
- [x] Relatório certificados: botões PDF e Excel na tela Validade dos Certificados (ao lado de Atualizar/Renovar em Lote)
- [x] Relatório certificados: geração Excel com dados dos certificados filtrados (frontend ExcelJS)
- [x] Relatório certificados: geração PDF com dados dos certificados filtrados (frontend jsPDF)
- [x] Relatório certificados: cabeçalho LAN7 - Pegasus nos relatórios
- [x] Auto-Retomada CT-e: implementar lógica backend igual à NFe (auto_correcao_pdf_cte, auto_retomada_infinita_cte)
- [x] Auto-Retomada CT-e: UI na tela Ferramentas (seção CT-e) com toggle, tempo de espera, retomada infinita
- [x] Auto-Retomada CT-e: executar após batch download CT-e (downloadTodos/downloadSelecionados)
- [x] Relatório certificados: botões PDF e Excel na tela Validade dos Certificados
- [x] Relatório certificados: geração Excel e PDF implementada no frontend
- [x] Reorganizar layout Ferramentas: usar espaço vazio à direita (3 colunas em vez de 2)
- [x] Auto-Retomada CT-e: card na tela Ferramentas com toggle, tempo de espera, retomada infinita
- [x] BUG: Badge "Contabilidade" na sidebar com contraste ruim no tema escuro - texto ilegível
- [x] BUG: Ícones e textos da sidebar em azul ficam ruins no tema claro - ajustar para funcionar em todos os temas
- [ ] BUG CRÍTICO: "Apagar Tudo" não limpa tabela de notas fiscais - dados antigos permanecem nos relatórios após reimportação
- [ ] Manual do Usuário PDF com ilustrações (incluindo CT-e e todas funcionalidades)
- [ ] Manual Técnico do Sistema PDF (documentação técnica completa)
- [ ] Script de vídeo para Veed.io (funcionalidades e vantagens do Pegasus)
